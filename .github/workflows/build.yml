name: Build and Release

on:
  push:
    branches: [ "master" ]
    paths:
      - .github/workflows/build.yml
      - gradle/**
      - build.gradle.kts
      - settings.gradle.kts
      - aether-*/src/**
      - aether-*/build.gradle.kts
      - aether-web/frontend/**
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      version: ${{ steps.get_version.outputs.VERSION }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'zulu'

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: aether-web/frontend/package-lock.json

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: wrapper
          cache-overwrite-existing: true
          cache-read-only: false
          build-scan-terms-of-use-url: "https://gradle.com/terms-of-service"
          build-scan-terms-of-use-agree: "yes"

      - name: Extract Version from Gradle
        id: get_version
        run: |
          VERSION=$(grep 'version =' build.gradle.kts | head -1 | sed 's/.*version = "//' | sed 's/".*//')
          echo "Detected version: $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: Build Full (with Web Panel)
        run: |
          chmod +x gradlew
          ./gradlew :aether-proxy:shadowJar :aether-server:build

      - name: Rename artifacts (with Web)
        run: |
          mkdir -p artifacts/with-web
          cp aether-proxy/build/libs/aether-proxy-*.jar artifacts/with-web/
          cp aether-server/build/libs/aether-server-*.jar artifacts/with-web/
          cd artifacts/with-web
          for f in *.jar; do mv "$f" "${f%.jar}-web.jar" 2>/dev/null || true; done

      - name: Build Lite (without Web Panel)
        run: |
          rm -rf aether-web/frontend/dist
          rm -rf aether-web/src/main/resources/static
          mkdir -p aether-web/src/main/resources/static
          echo '<!DOCTYPE html><html><body><h1>Web Panel not included</h1><p>Use aether-proxy-*-web.jar for Web Panel</p></body></html>' > aether-web/src/main/resources/static/index.html
          ./gradlew :aether-proxy:shadowJar -x buildFrontend -x npmInstall

      - name: Rename artifacts (lite)
        run: |
          mkdir -p artifacts/lite
          cp aether-proxy/build/libs/aether-proxy-*.jar artifacts/lite/
          cp aether-server/build/libs/aether-server-*.jar artifacts/lite/
          cd artifacts/lite
          for f in *-web.jar; do mv "$f" "${f%-web.jar}-lite.jar" 2>/dev/null || true; done
          for f in *.jar; do
            if [[ ! "$f" == *-lite.jar ]]; then
              mv "$f" "${f%.jar}-lite.jar" 2>/dev/null || true
            fi
          done

      - name: Upload aether-server artifact
        uses: actions/upload-artifact@v4
        with:
          name: aether-server-${{ steps.get_version.outputs.VERSION }}
          path: artifacts/with-web/aether-server-*.jar
          if-no-files-found: error

      - name: Upload aether-proxy-web artifact
        uses: actions/upload-artifact@v4
        with:
          name: aether-proxy-web-${{ steps.get_version.outputs.VERSION }}
          path: artifacts/with-web/aether-proxy-*.jar
          if-no-files-found: error

      - name: Upload aether-proxy-lite artifact
        uses: actions/upload-artifact@v4
        with:
          name: aether-proxy-lite-${{ steps.get_version.outputs.VERSION }}
          path: artifacts/lite/aether-proxy-*-lite.jar
          if-no-files-found: error

  release:
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    steps:
      - name: Download aether-server artifact
        uses: actions/download-artifact@v4
        with:
          name: aether-server-${{ needs.build.outputs.version }}
          path: artifacts

      - name: Download aether-proxy-web artifact
        uses: actions/download-artifact@v4
        with:
          name: aether-proxy-web-${{ needs.build.outputs.version }}
          path: artifacts

      - name: Download aether-proxy-lite artifact
        uses: actions/download-artifact@v4
        with:
          name: aether-proxy-lite-${{ needs.build.outputs.version }}
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ needs.build.outputs.version }}
          name: "Aether v${{ needs.build.outputs.version }}"
          draft: false
          prerelease: false
          body: |
            ## ğŸš€ Aether v${{ needs.build.outputs.version }}
            
            **Cross-server communication system** for AllayMC and WaterdogPE networks with optimized TCP/QUIC transport.
            
            ### ğŸ“¦ Downloads
            
            | File | Description |
            |------|-------------|
            | `aether-server-*-web.jar` | **AllayMC Plugin** - Install on each game server |
            | `aether-proxy-*-web.jar` | **WaterdogPE Plugin** - Full version with Web Admin Panel |
            | `aether-proxy-*-lite.jar` | **WaterdogPE Plugin** - Lightweight version without Web Panel |
            
            ### ğŸ”§ Quick Setup
            
            1. Place `aether-proxy-*.jar` in your WaterdogPE `plugins/` folder
            2. Place `aether-server-*.jar` in each AllayMC server `plugins/` folder
            3. Configure `config.yml` on each server with matching `secret-key`
            4. Start proxy, then start game servers
            5. Access Web Panel at `http://localhost:8080` (default: admin/admin)
            
            ### âœ¨ Features
            
            - ğŸŒ **Web Admin Panel** - Beautiful dashboard for monitoring
            - ğŸ”— **ProxyTransport** - TCP/QUIC transport for lower latency
            - ğŸ‘¥ **Real-time sync** - Player counts, TPS, server status
            - ğŸŒ€ **Portal System** - Region-based server transfer
            - âš–ï¸ **Load Balancer** - Multiple strategies (Round Robin, Least Connections, etc.)
            - ğŸ“¡ **Event Bridge** - Cross-server events and messaging
            - ğŸ”„ **Auto-reconnect** - Automatic recovery on connection loss
            - ğŸ“Š **PlaceholderAPI** - Integration for scorebards and chat
            
            ### ğŸ” Security Notice
            
            âš ï¸ **Change default credentials immediately!**
            - Default login: `admin` / `admin`
            - SSL certificate recommended for production
            
            ### ğŸ“š Documentation
            
            - [API Documentation](https://github.com/Miroshka000/Aether/blob/master/docs/API.md)
            - [README (English)](https://github.com/Miroshka000/Aether/blob/master/README.md)
            - [README (Ğ ÑƒÑÑĞºĞ¸Ğ¹)](https://github.com/Miroshka000/Aether/blob/master/README_RU.md)
            
            ---
            
            **Full Changelog**: https://github.com/Miroshka000/Aether/commits/v${{ needs.build.outputs.version }}
          files: |
            artifacts/*.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
